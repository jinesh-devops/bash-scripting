#!/bin/bash
###############################
# Author: Cheedella Jinesh
# Date: 2025-11-04 
# Description: This script scans Docker containers for known vulnerabilities using Trivy and generates a report.
# Usage: ./container_vulnerability_scanner.sh <image_name> <critical_threshold> [--send-email]
# Example: ./container_vulnerability_scanner.sh myapp:latest 5
###############################

set -o pipefail
set -e

# args
if [ $# -lt 2 ] || [ $# -gt 3 ]; then
    echo "Usage: $0 <image_name> <critical_threshold> [--send-email]"
    echo "Example: $0 myapp:latest 5"
    exit 1
fi
IMAGE_NAME=$1
CRITICAL_THRESHOLD=$2
SEND_EMAIL_FLAG=$3
# dependencies
if ! command -v docker >/dev/null 2>&1; then
    echo "Error: docker not found. Install and retry."
    exit 3
fi
if ! command -v trivy >/dev/null 2>&1; then
    echo "Error: trivy not found. Install and retry."
    exit 4
fi
# validate critical_threshold
if ! [[ "$CRITICAL_THRESHOLD" =~ ^[0-9]+$ ]] || [ "$CRITICAL_THRESHOLD" -lt 0 ]; then
    echo "Error: critical_threshold must be a positive integer."
    exit 1
fi
# files & logging
LOG_FILE="/var/log/container_vuln_scanner.log"
CSV_FILE="/var/log/container_vuln_report_$(date +%F).csv"
touch "$LOG_FILE" 2>/dev/null || { echo "Error: Cannot write to $LOG_FILE (permission)."; exit 5; }
# create CSV header only once
if [ ! -f "$CSV_FILE" ] || [ ! -s "$CSV_FILE" ]; then
    echo "Date,Image,Severity,CriticalCount,HighCount,MediumCount,Threshold,AlertDetected" > "$CSV_FILE"
fi
# check if image exists locally, else pull it
if ! docker image inspect "$IMAGE_NAME" >/dev/null 2>&1; then
    echo "Image '$IMAGE_NAME' not found locally. Attempting to pull..."
    if ! docker pull "$IMAGE_NAME" >/dev/null 2>&1; then
        echo "Error: Unable to pull image '$IMAGE_NAME'. Check the image name and try again."
        exit 6
    fi
fi
# run trivy scan
scan_output=$(trivy image --severity CRITICAL,HIGH,MEDIUM --quiet --format json "$IMAGE_NAME" 2>/dev/null)
if [ -z "$scan_output" ]; then
    echo "Error: Trivy scan failed for image '$IMAGE_NAME'."
    exit 7
fi
# parse results
critical_count=$(echo "$scan_output" | jq '[.Results[].Vulnerabilities[] | select(.Severity=="CRITICAL")] | length' 2>/dev/null)
high_count=$(echo "$scan_output" | jq '[.Results[].Vulnerabilities[] | select(.Severity=="HIGH")] | length' 2>/dev/null)
medium_count=$(echo "$scan_output" | jq '[.Results[].Vulnerabilities[] | select(.Severity=="MEDIUM")] | length' 2>/dev/null)
# determine alert status
if [ "$critical_count" -gt "$CRITICAL_THRESHOLD" ]; then
    alert_status="ALERT: Critical vulnerabilities exceeded allowed threshold!"
    color_code="\e[31m" # Red
else
    alert_status="OK"
    color_code="\e[32m" # Green
fi
# print summary
echo -e "${color_code}Vulnerability Report for Image: $IMAGE_NAME
Critical: $critical_count
High: $high_count
Medium: $medium_count
Threshold: $CRITICAL_THRESHOLD
Status: $alert_status\e[0m"
# log to CSV
echo "$(date +%F),$IMAGE_NAME,CRITICAL,$critical_count,$high_count,$medium_count,$CRITICAL_THRESHOLD,$alert_status" >> "$CSV_FILE"
# log event
echo "$(date +'%Y-%m-%d %H:%M:%S') - Scanned Image: $IMAGE_NAME, Critical: $critical_count, High: $high_count, Medium: $medium_count, Threshold: $CRITICAL_THRESHOLD, Status: $alert_status" >> "$LOG_FILE"
exit 0
# End of script


